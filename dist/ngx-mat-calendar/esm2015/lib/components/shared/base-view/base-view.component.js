import { Component, EventEmitter, Input, Output } from '@angular/core';
import { areIntervalsOverlapping, endOfDay, getHours, getMinutes, intervalToDuration, isSameDay, startOfDay } from 'date-fns';
import { CalendarEvent, CalendarEventGrid } from '../../../models/CalendarEvent';
import { v4 as uuidv4 } from 'uuid';
import { hoursOfDay } from '../../../models/Times';
import { interval, Subscription } from 'rxjs';
import { tap } from 'rxjs/internal/operators/tap';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/formatting.service";
export class BaseViewComponent {
    constructor(formattingService) {
        this.formattingService = formattingService;
        this.eventClick = new EventEmitter();
        this.changeToDayView = new EventEmitter();
        this.subscriptions$ = new Subscription();
        this.markerPosition = 0;
        this.hoursOfDay = hoursOfDay;
        this.pixelsPerHour = 0;
        this.selectedDate = new Date();
        this.events = [];
    }
    ngOnInit() {
        this.subscriptions$.add(this.options$.pipe(tap((options) => {
            this.options = options;
            this.markerPosition = this.calculateMarkerPosition();
            this.pixelsPerHour = this.options.getPixelsPerMinute * 60;
        })).subscribe());
        this.subscriptions$.add(this.selectedDate$.pipe(tap(selectedDate => {
            this.selectedDate = selectedDate;
        })).subscribe());
        this.subscriptions$.add(interval(60000).pipe(tap(() => {
            this.markerPosition = this.calculateMarkerPosition();
        })).subscribe());
    }
    createEventGroups(day) {
        day.events.map((event) => {
            const uuid = uuidv4();
            let eventGroup = [];
            if (event.grid) {
                const eventsNotAllDay = day.events.filter(x => !x.allDay);
                eventGroup = this.getOverlappingEvents(event, eventsNotAllDay, event.grid.eventGroups);
                eventGroup.map((overlapEvent) => {
                    if (overlapEvent.grid) {
                        overlapEvent.grid.eventGroups.push(uuid);
                        overlapEvent.grid.eventsInGroup = eventGroup.length;
                    }
                    if (!day.eventGroups.includes(uuid)) {
                        day.eventGroups.push(uuid);
                    }
                });
            }
        });
        this.setEventSizes(day);
        return day;
    }
    populateEvents(event, day) {
        const populatedEvent = new CalendarEvent(Object.assign(Object.assign({}, event), { grid: this.calculatePixelsOffsetForEvent(event, day) }));
        return populatedEvent;
    }
    getOverlappingEvents(event, events, eventGroups) {
        return events.filter((compareEvent) => {
            const eventsDoOverlap = areIntervalsOverlapping({ start: event.startTime, end: event.endTime }, { start: compareEvent.startTime, end: compareEvent.endTime }, { inclusive: true });
            let isAlreadyInEventGroup = false;
            if (compareEvent.grid) {
                isAlreadyInEventGroup = compareEvent.grid.eventGroups.some((eventGroup) => {
                    return eventGroups.includes(eventGroup);
                });
            }
            return eventsDoOverlap && !isAlreadyInEventGroup;
        });
    }
    setEventSizes(day) {
        day.eventGroups.forEach(eventGroup => {
            const eventGroupEvents = day.events.filter((event) => {
                var _a;
                return (_a = event.grid) === null || _a === void 0 ? void 0 : _a.eventGroups.includes(eventGroup);
            });
            let index = 0;
            eventGroupEvents.forEach((event) => {
                if (event.grid) {
                    event.grid.width = 100 / (eventGroupEvents.length);
                    event.grid.offsetLeft = event.grid.width * index;
                }
                // check if already has a width/offsetLeft to determine if it's in eventgroup A or B
                index++;
            });
        });
    }
    calculatePixelsOffsetForEvent(event, day) {
        let grid = new CalendarEventGrid();
        const startTime = event.startTime;
        const endTime = isSameDay(event.startTime, event.endTime) ?
            event.endTime :
            endOfDay(event.startTime);
        const eventDurationFromStartTime = intervalToDuration({
            start: startTime,
            end: endTime
        });
        const eventDurationFromMidnight = intervalToDuration({
            start: startOfDay(day.date),
            end: event.endTime
        });
        eventDurationFromStartTime.hours = eventDurationFromStartTime.hours || 0;
        eventDurationFromStartTime.minutes = eventDurationFromStartTime.minutes || 0;
        eventDurationFromMidnight.hours = eventDurationFromMidnight.hours || 0;
        eventDurationFromMidnight.minutes = eventDurationFromMidnight.minutes || 0;
        const offsetInMinutes = !isSameDay(event.startTime, event.endTime) && isSameDay(event.endTime, day.date) ?
            0 : Math.abs(getHours(startTime)) * 60 + getMinutes(startTime);
        const durationOffset = !isSameDay(event.startTime, event.endTime) && isSameDay(event.endTime, day.date) ?
            eventDurationFromMidnight.hours * 60 + eventDurationFromMidnight.minutes :
            eventDurationFromStartTime.hours * 60 + eventDurationFromStartTime.minutes;
        grid = Object.assign(Object.assign({}, grid), { offsetTop: offsetInMinutes * this.options.getPixelsPerMinute, durationOffset: durationOffset * this.options.getPixelsPerMinute });
        return grid;
    }
    getCellHeight(time) {
        if (time.isEnd) {
            return 20;
        }
        return this.pixelsPerHour;
    }
    calculateMarkerPosition() {
        const now = new Date();
        const offsetTop = (getHours(now) * 60 + getMinutes(now)) * this.options.getPixelsPerMinute;
        return offsetTop;
    }
    isToday(date) {
        return this.formattingService.isToday(date);
    }
    getDayName(date) {
        return this.formattingService.getDayName(date);
    }
    getDayNumber(date) {
        return this.formattingService.getDayNumber(date);
    }
    getTime(date) {
        return this.formattingService.getTime(date);
    }
    onEventClick(event) {
        this.eventClick.emit(event);
    }
    navigateToDayView(date) {
        this.changeToDayView.emit(date);
    }
    sortByTime(a, b) {
        return a.startTime.getTime() - b.startTime.getTime();
    }
    sortByAllDay(event) {
        return event.allDay ? -1 : 1;
    }
    isSameDay(date, startTime, endTime) {
        return isSameDay(new Date(date), new Date(startTime)) || isSameDay(new Date(date), new Date(endTime));
    }
    ngOnDestroy() {
        this.subscriptions$.unsubscribe();
    }
}
BaseViewComponent.ɵfac = function BaseViewComponent_Factory(t) { return new (t || BaseViewComponent)(i0.ɵɵdirectiveInject(i1.FormattingService)); };
BaseViewComponent.ɵcmp = i0.ɵɵdefineComponent({ type: BaseViewComponent, selectors: [["ng-component"]], inputs: { options$: "options$", selectedDate$: "selectedDate$", events$: "events$" }, outputs: { eventClick: "eventClick", changeToDayView: "changeToDayView" }, decls: 0, vars: 0, template: function BaseViewComponent_Template(rf, ctx) { }, encapsulation: 2 });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(BaseViewComponent, [{
        type: Component,
        args: [{
                template: ''
            }]
    }], function () { return [{ type: i1.FormattingService }]; }, { options$: [{
            type: Input
        }], selectedDate$: [{
            type: Input
        }], events$: [{
            type: Input
        }], eventClick: [{
            type: Output
        }], changeToDayView: [{
            type: Output
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS12aWV3LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1tYXQtY2FsZW5kYXIvc3JjL2xpYi9jb21wb25lbnRzL3NoYXJlZC9iYXNlLXZpZXcvYmFzZS12aWV3LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQXFCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUU5SCxPQUFPLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDakYsT0FBTyxFQUFFLEVBQUUsSUFBSSxNQUFNLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRW5ELE9BQU8sRUFBRSxRQUFRLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQzs7O0FBS2xELE1BQU0sT0FBZ0IsaUJBQWlCO0lBaUJuQyxZQUNjLGlCQUFvQztRQUFwQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBYnhDLGVBQVUsR0FBZ0MsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM3RCxvQkFBZSxHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRXpELG1CQUFjLEdBQWlCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDckQsbUJBQWMsR0FBRyxDQUFDLENBQUM7UUFHMUIsZUFBVSxHQUFHLFVBQVUsQ0FBQztRQUN4QixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUNsQixp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QUFDLENBQUM7SUFDakMsQ0FBQztJQUVTLFNBQVMsQ0FBQyxJQUFVLEVBQUUsU0FBZSxFQUFFLE9BQWE7UUFDMUQsT0FBTyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUMxRyxDQUFDO0lBRUQsV0FBVztRQUNSLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDckMsQ0FBQzs7a0ZBek5pQixpQkFBaUI7c0RBQWpCLGlCQUFpQjt1RkFBakIsaUJBQWlCO2NBSHRDLFNBQVM7ZUFBQztnQkFDUCxRQUFRLEVBQUUsRUFBRTthQUNmO29FQUVZLFFBQVE7a0JBQWhCLEtBQUs7WUFDRyxhQUFhO2tCQUFyQixLQUFLO1lBQ0csT0FBTztrQkFBZixLQUFLO1lBRUksVUFBVTtrQkFBbkIsTUFBTTtZQUNHLGVBQWU7a0JBQXhCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGFyZUludGVydmFsc092ZXJsYXBwaW5nLCBlbmRPZkRheSwgZ2V0SG91cnMsIGdldE1pbnV0ZXMsIGludGVydmFsVG9EdXJhdGlvbiwgaXNTYW1lRGF5LCBzdGFydE9mRGF5IH0gZnJvbSAnZGF0ZS1mbnMnO1xuaW1wb3J0IHsgQ2FsZW5kYXJEYXkgfSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvQ2FsZW5kYXJEYXknO1xuaW1wb3J0IHsgQ2FsZW5kYXJFdmVudCwgQ2FsZW5kYXJFdmVudEdyaWQgfSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvQ2FsZW5kYXJFdmVudCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCB7IENhbGVuZGFyT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9DYWxlbmRhck9wdGlvbnMnO1xuaW1wb3J0IHsgaG91cnNPZkRheSB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9UaW1lcyc7XG5pbXBvcnQgeyBGb3JtYXR0aW5nU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm1hdHRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBpbnRlcnZhbCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL2ludGVybmFsL29wZXJhdG9ycy90YXAnO1xuXG5AQ29tcG9uZW50KHtcbiAgICB0ZW1wbGF0ZTogJydcbn0pXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZVZpZXdDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gICAgQElucHV0KCkgb3B0aW9ucyQ6IE9ic2VydmFibGU8Q2FsZW5kYXJPcHRpb25zPjtcbiAgICBASW5wdXQoKSBzZWxlY3RlZERhdGUkOiBPYnNlcnZhYmxlPERhdGU+O1xuICAgIEBJbnB1dCgpIGV2ZW50cyQ6IE9ic2VydmFibGU8Q2FsZW5kYXJFdmVudFtdPjtcblxuICAgIEBPdXRwdXQoKSBldmVudENsaWNrOiBFdmVudEVtaXR0ZXI8Q2FsZW5kYXJFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgQE91dHB1dCgpIGNoYW5nZVRvRGF5VmlldzogRXZlbnRFbWl0dGVyPERhdGU+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgcHJvdGVjdGVkIHN1YnNjcmlwdGlvbnMkOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gICAgcHVibGljIG1hcmtlclBvc2l0aW9uID0gMDtcblxuICAgIG9wdGlvbnM6IENhbGVuZGFyT3B0aW9ucztcbiAgICBob3Vyc09mRGF5ID0gaG91cnNPZkRheTtcbiAgICBwaXhlbHNQZXJIb3VyID0gMDtcbiAgICBzZWxlY3RlZERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIGV2ZW50czogQ2FsZW5kYXJFdmVudFtdID0gW107XG5cbiAgICBwcm90ZWN0ZWQgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBmb3JtYXR0aW5nU2VydmljZTogRm9ybWF0dGluZ1NlcnZpY2VcbiAgICApIHtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zJC5hZGQoXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMkLnBpcGUoXG4gICAgICAgICAgICAgICAgdGFwKChvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFya2VyUG9zaXRpb24gPSB0aGlzLmNhbGN1bGF0ZU1hcmtlclBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGl4ZWxzUGVySG91ciA9IHRoaXMub3B0aW9ucy5nZXRQaXhlbHNQZXJNaW51dGUgKiA2MDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoKVxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucyQuYWRkKFxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZERhdGUkLnBpcGUoXG4gICAgICAgICAgICAgICAgdGFwKHNlbGVjdGVkRGF0ZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWREYXRlID0gc2VsZWN0ZWREYXRlO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLnN1YnNjcmliZSgpXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zJC5hZGQoXG4gICAgICAgICAgICBpbnRlcnZhbCg2MDAwMCkucGlwZShcbiAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcmtlclBvc2l0aW9uID0gdGhpcy5jYWxjdWxhdGVNYXJrZXJQb3NpdGlvbigpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLnN1YnNjcmliZSgpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUV2ZW50R3JvdXBzKGRheTogQ2FsZW5kYXJEYXkpOiBDYWxlbmRhckRheSB7XG4gICAgICAgIGRheS5ldmVudHMubWFwKChldmVudDogQ2FsZW5kYXJFdmVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdXVpZCA9IHV1aWR2NCgpO1xuICAgICAgICAgICAgbGV0IGV2ZW50R3JvdXA6IENhbGVuZGFyRXZlbnRbXSA9IFtdO1xuXG4gICAgICAgICAgICBpZiAoZXZlbnQuZ3JpZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50c05vdEFsbERheSA9IGRheS5ldmVudHMuZmlsdGVyKHggPT4gIXguYWxsRGF5KTtcbiAgICAgICAgICAgICAgICBldmVudEdyb3VwID0gdGhpcy5nZXRPdmVybGFwcGluZ0V2ZW50cyhldmVudCwgZXZlbnRzTm90QWxsRGF5LCBldmVudC5ncmlkLmV2ZW50R3JvdXBzKTtcblxuICAgICAgICAgICAgICAgIGV2ZW50R3JvdXAubWFwKChvdmVybGFwRXZlbnQ6IENhbGVuZGFyRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJsYXBFdmVudC5ncmlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVybGFwRXZlbnQuZ3JpZC5ldmVudEdyb3Vwcy5wdXNoKHV1aWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxhcEV2ZW50LmdyaWQuZXZlbnRzSW5Hcm91cCA9IGV2ZW50R3JvdXAubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkYXkuZXZlbnRHcm91cHMuaW5jbHVkZXModXVpZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRheS5ldmVudEdyb3Vwcy5wdXNoKHV1aWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuc2V0RXZlbnRTaXplcyhkYXkpO1xuXG4gICAgICAgIHJldHVybiBkYXk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBvcHVsYXRlRXZlbnRzKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBkYXk6IENhbGVuZGFyRGF5KTogQ2FsZW5kYXJFdmVudCB7XG4gICAgICAgIGNvbnN0IHBvcHVsYXRlZEV2ZW50ID0gbmV3IENhbGVuZGFyRXZlbnQoe1xuICAgICAgICAgICAgLi4uZXZlbnQsXG4gICAgICAgICAgICBncmlkOiB0aGlzLmNhbGN1bGF0ZVBpeGVsc09mZnNldEZvckV2ZW50KGV2ZW50LCBkYXkpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwb3B1bGF0ZWRFdmVudDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE92ZXJsYXBwaW5nRXZlbnRzKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBldmVudHM6IENhbGVuZGFyRXZlbnRbXSwgZXZlbnRHcm91cHM6IHN0cmluZ1tdKTogQ2FsZW5kYXJFdmVudFtdIHtcbiAgICAgICAgcmV0dXJuIGV2ZW50cy5maWx0ZXIoKGNvbXBhcmVFdmVudDogQ2FsZW5kYXJFdmVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXZlbnRzRG9PdmVybGFwID0gYXJlSW50ZXJ2YWxzT3ZlcmxhcHBpbmcoXG4gICAgICAgICAgICAgICAgeyBzdGFydDogZXZlbnQuc3RhcnRUaW1lLCBlbmQ6IGV2ZW50LmVuZFRpbWUgfSxcbiAgICAgICAgICAgICAgICB7IHN0YXJ0OiBjb21wYXJlRXZlbnQuc3RhcnRUaW1lLCBlbmQ6IGNvbXBhcmVFdmVudC5lbmRUaW1lIH0sXG4gICAgICAgICAgICAgICAgeyBpbmNsdXNpdmU6IHRydWUgfVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGV0IGlzQWxyZWFkeUluRXZlbnRHcm91cCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGNvbXBhcmVFdmVudC5ncmlkKSB7XG4gICAgICAgICAgICAgICAgaXNBbHJlYWR5SW5FdmVudEdyb3VwID0gY29tcGFyZUV2ZW50LmdyaWQuZXZlbnRHcm91cHMuc29tZSgoZXZlbnRHcm91cDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudEdyb3Vwcy5pbmNsdWRlcyhldmVudEdyb3VwKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGV2ZW50c0RvT3ZlcmxhcCAmJiAhaXNBbHJlYWR5SW5FdmVudEdyb3VwO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldEV2ZW50U2l6ZXMoZGF5OiBDYWxlbmRhckRheSk6IHZvaWQge1xuICAgICAgICBkYXkuZXZlbnRHcm91cHMuZm9yRWFjaChldmVudEdyb3VwID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50R3JvdXBFdmVudHMgPSBkYXkuZXZlbnRzLmZpbHRlcigoZXZlbnQ6IENhbGVuZGFyRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQuZ3JpZD8uZXZlbnRHcm91cHMuaW5jbHVkZXMoZXZlbnRHcm91cCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGluZGV4ID0gMDtcbiAgICAgICAgICAgIGV2ZW50R3JvdXBFdmVudHMuZm9yRWFjaCgoZXZlbnQ6IENhbGVuZGFyRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZ3JpZCkge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5ncmlkLndpZHRoID0gMTAwIC8gKGV2ZW50R3JvdXBFdmVudHMubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuZ3JpZC5vZmZzZXRMZWZ0ID0gZXZlbnQuZ3JpZC53aWR0aCAqIGluZGV4O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFscmVhZHkgaGFzIGEgd2lkdGgvb2Zmc2V0TGVmdCB0byBkZXRlcm1pbmUgaWYgaXQncyBpbiBldmVudGdyb3VwIEEgb3IgQlxuXG4gICAgICAgICAgICAgICAgaW5kZXgrKztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVBpeGVsc09mZnNldEZvckV2ZW50KGV2ZW50OiBDYWxlbmRhckV2ZW50LCBkYXk6IENhbGVuZGFyRGF5KTogQ2FsZW5kYXJFdmVudEdyaWQge1xuICAgICAgICBsZXQgZ3JpZCA9IG5ldyBDYWxlbmRhckV2ZW50R3JpZCgpO1xuXG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IGV2ZW50LnN0YXJ0VGltZTtcbiAgICAgICAgY29uc3QgZW5kVGltZSA9IGlzU2FtZURheShldmVudC5zdGFydFRpbWUsIGV2ZW50LmVuZFRpbWUpID9cbiAgICAgICAgICAgIGV2ZW50LmVuZFRpbWUgOlxuICAgICAgICAgICAgZW5kT2ZEYXkoZXZlbnQuc3RhcnRUaW1lKTtcblxuICAgICAgICBjb25zdCBldmVudER1cmF0aW9uRnJvbVN0YXJ0VGltZSA9IGludGVydmFsVG9EdXJhdGlvbih7XG4gICAgICAgICAgICBzdGFydDogc3RhcnRUaW1lLFxuICAgICAgICAgICAgZW5kOiBlbmRUaW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50RHVyYXRpb25Gcm9tTWlkbmlnaHQgPSBpbnRlcnZhbFRvRHVyYXRpb24oe1xuICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0T2ZEYXkoZGF5LmRhdGUpLFxuICAgICAgICAgICAgZW5kOiBldmVudC5lbmRUaW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGV2ZW50RHVyYXRpb25Gcm9tU3RhcnRUaW1lLmhvdXJzID0gZXZlbnREdXJhdGlvbkZyb21TdGFydFRpbWUuaG91cnMgfHwgMDtcbiAgICAgICAgZXZlbnREdXJhdGlvbkZyb21TdGFydFRpbWUubWludXRlcyA9IGV2ZW50RHVyYXRpb25Gcm9tU3RhcnRUaW1lLm1pbnV0ZXMgfHwgMDtcbiAgICAgICAgZXZlbnREdXJhdGlvbkZyb21NaWRuaWdodC5ob3VycyA9IGV2ZW50RHVyYXRpb25Gcm9tTWlkbmlnaHQuaG91cnMgfHwgMDtcbiAgICAgICAgZXZlbnREdXJhdGlvbkZyb21NaWRuaWdodC5taW51dGVzID0gZXZlbnREdXJhdGlvbkZyb21NaWRuaWdodC5taW51dGVzIHx8IDA7XG5cbiAgICAgICAgY29uc3Qgb2Zmc2V0SW5NaW51dGVzID0gIWlzU2FtZURheShldmVudC5zdGFydFRpbWUsIGV2ZW50LmVuZFRpbWUpICYmIGlzU2FtZURheShldmVudC5lbmRUaW1lLCBkYXkuZGF0ZSkgP1xuICAgICAgICAgICAgMCA6IE1hdGguYWJzKGdldEhvdXJzKHN0YXJ0VGltZSkpICogNjAgKyBnZXRNaW51dGVzKHN0YXJ0VGltZSk7XG5cbiAgICAgICAgY29uc3QgZHVyYXRpb25PZmZzZXQgPSAhaXNTYW1lRGF5KGV2ZW50LnN0YXJ0VGltZSwgZXZlbnQuZW5kVGltZSkgJiYgaXNTYW1lRGF5KGV2ZW50LmVuZFRpbWUsIGRheS5kYXRlKSA/XG4gICAgICAgICAgICBldmVudER1cmF0aW9uRnJvbU1pZG5pZ2h0LmhvdXJzICogNjAgKyBldmVudER1cmF0aW9uRnJvbU1pZG5pZ2h0Lm1pbnV0ZXMgOlxuICAgICAgICAgICAgZXZlbnREdXJhdGlvbkZyb21TdGFydFRpbWUuaG91cnMgKiA2MCArIGV2ZW50RHVyYXRpb25Gcm9tU3RhcnRUaW1lLm1pbnV0ZXM7XG5cbiAgICAgICAgZ3JpZCA9IHtcbiAgICAgICAgICAgIC4uLmdyaWQsXG4gICAgICAgICAgICBvZmZzZXRUb3A6IG9mZnNldEluTWludXRlcyAqIHRoaXMub3B0aW9ucy5nZXRQaXhlbHNQZXJNaW51dGUsXG4gICAgICAgICAgICBkdXJhdGlvbk9mZnNldDogZHVyYXRpb25PZmZzZXQgKiB0aGlzLm9wdGlvbnMuZ2V0UGl4ZWxzUGVyTWludXRlXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGdyaWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENlbGxIZWlnaHQodGltZTogYW55KTogbnVtYmVyIHtcbiAgICAgICAgaWYgKHRpbWUuaXNFbmQpIHtcbiAgICAgICAgICAgIHJldHVybiAyMDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLnBpeGVsc1BlckhvdXI7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNhbGN1bGF0ZU1hcmtlclBvc2l0aW9uKCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGNvbnN0IG9mZnNldFRvcCA9IChnZXRIb3Vycyhub3cpICogNjAgKyBnZXRNaW51dGVzKG5vdykpICogdGhpcy5vcHRpb25zLmdldFBpeGVsc1Blck1pbnV0ZTtcblxuICAgICAgICByZXR1cm4gb2Zmc2V0VG9wO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1RvZGF5KGRhdGU6IERhdGUpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0dGluZ1NlcnZpY2UuaXNUb2RheShkYXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGF5TmFtZShkYXRlOiBEYXRlKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0dGluZ1NlcnZpY2UuZ2V0RGF5TmFtZShkYXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGF5TnVtYmVyKGRhdGU6IERhdGUpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXR0aW5nU2VydmljZS5nZXREYXlOdW1iZXIoZGF0ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRpbWUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmZvcm1hdHRpbmdTZXJ2aWNlLmdldFRpbWUoZGF0ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uRXZlbnRDbGljayhldmVudDogQ2FsZW5kYXJFdmVudCk6IHZvaWQge1xuICAgICAgICB0aGlzLmV2ZW50Q2xpY2suZW1pdChldmVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlVG9EYXlWaWV3KGRhdGU6IERhdGUpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VUb0RheVZpZXcuZW1pdChkYXRlKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc29ydEJ5VGltZShhOiBDYWxlbmRhckV2ZW50LCBiOiBDYWxlbmRhckV2ZW50KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGEuc3RhcnRUaW1lLmdldFRpbWUoKSAtIGIuc3RhcnRUaW1lLmdldFRpbWUoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc29ydEJ5QWxsRGF5KGV2ZW50OiBDYWxlbmRhckV2ZW50KTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGV2ZW50LmFsbERheSA/IC0xIDogMTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaXNTYW1lRGF5KGRhdGU6IERhdGUsIHN0YXJ0VGltZTogRGF0ZSwgZW5kVGltZTogRGF0ZSk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gaXNTYW1lRGF5KG5ldyBEYXRlKGRhdGUpLCBuZXcgRGF0ZShzdGFydFRpbWUpKSB8fCBpc1NhbWVEYXkobmV3IERhdGUoZGF0ZSksIG5ldyBEYXRlKGVuZFRpbWUpKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMkLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxufVxuIl19